jQuery(document).ready(function ($) {
    const pluginSlug = rwwclDeactivate.slug;

    $(document).on(
        'click',
        `tr[data-slug="${pluginSlug}"] .deactivate a`,
        function (e) {
            e.preventDefault();

            const deactivateUrl = $(this).attr('href');
            showSurveyModal(deactivateUrl);
        }
    );

    function showSurveyModal(deactivateUrl) {
        const modal = $(`
                    <div class="rwwcl-webp-modal">
                        <div class="rwwcl-webp-modal-content">
                            <button class="rwwcl-webp-modal-close" aria-label="Close">×</button>
                
                            <h3>Mind telling us what didn’t work for you?</h3>
                
                            <div class="rwwcl-webp-modal-options">
                                <label><input type="radio" name="reason" value="not_working"> The plugin didn’t work as expected</label>
                                <label><input type="radio" name="reason" value="performance"> Performance or compatibility issues</label>
                                <label><input type="radio" name="reason" value="found_better_plugin"> Found a better plugin</label>
                                <label><input type="radio" name="reason" value="other"> Other</label>
                            </div>
                            
                            <div class="rwwcl-webp-reason-detail" style="display:none;">
                                    <input type="text" class="rwwcl-webp-reason-text" maxlength="200" placeholder="" />
                                    <p class="rwwcl-webp-privacy-note">
                                        Please do not include any personal, sensitive, or private information
                                        (such as email addresses or account details).
                                    </p>
                            </div>
                    
                            <div class="rwwcl-webp-modal-actions">
                                <button class="submit rwwcl-primary">Submit & Deactivate</button>
                                <button class="skip rwwcl-secondary">Skip & Deactivate</button>
                            </div>
                        </div>
                    </div>
                    
              `);

        $('body').append(modal);

        modal.find('.skip').on('click', function () {
            modal.remove();
            window.location.href = deactivateUrl;
        });

        // 1️⃣ Click mask off.
        modal.on('click', function () {
            modal.remove();
        });

        // 2️⃣ Click on the content area not to close (prevent bubbling)
        modal.find('.rwwcl-webp-modal-content').on('click', function (e) {
            e.stopPropagation();
        });

        // 3️⃣ Click X in the upper right corner to close.
        modal.find('.rwwcl-webp-modal-close').on('click', function () {
            modal.remove();
        });

        modal.find('.submit').focus();

        const reasonDetailWrap = modal.find('.rwwcl-webp-reason-detail');
        const reasonTextarea   = modal.find('.rwwcl-webp-reason-text');

        modal.find('input[name="reason"]').on('change', function () {
            const value = $(this).val();

            if (value === 'found_better_plugin') {
                reasonTextarea.attr(
                    'placeholder',
                    'Please share which plugin'
                );
                reasonDetailWrap.show();
            } else if (value === 'other') {
                reasonTextarea.attr(
                    'placeholder',
                    'Please share the reason'
                );
                reasonDetailWrap.show();
            } else {
                reasonTextarea.val('');
                reasonDetailWrap.hide();
            }
        });

        modal.find('.submit').on('click', function () {
            const submitBtn = $(this);
            submitBtn.prop('disabled', true).text('Submitting...');

            const reason = modal.find('input[name="reason"]:checked').val() || '';
            const reasonDetail = modal.find('.rwwcl-webp-reason-text').val() || '';

            $.post(ajaxurl, {
                action: 'rwwcl_deactivate_feedback',
                nonce: rwwclDeactivate.nonce,
                reason: reason,
                reason_detail: reasonDetail
            }).done(function (response) {
                    // 可以根据 response 做提示或 log
                    modal.remove();
                    window.location.href = deactivateUrl;
            }).fail(function () {
                alert('Sorry, there was an error submitting your feedback. Please try again.');
                submitBtn.prop('disabled', false).text('Submit & Deactivate');
            });
        });

    }
});
