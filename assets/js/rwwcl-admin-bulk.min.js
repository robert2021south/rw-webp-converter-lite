jQuery(document).ready(function ($) {

    const $startBtn = $('#rwwcl-start-bulk');
    const $progressBox = $('#rwwcl-bulk-progress');
    const $progressInner = $('.rwwcl-progress-bar-inner');
    const $progressText = $('.rwwcl-progress-text');

    let isProcessing = false;
    let lastProgress = 0;
    let stallCount = 0;

    $startBtn.on('click', function () {

        if (isProcessing) return;
        isProcessing = true;
        $startBtn.prop('disabled', true);
        $startBtn.text('Convertingâ€¦');

        $progressBox.show();
        $progressInner.css('width', '0%');
        $progressText.text('0%');

        runBulkProcess();
    });

    function runBulkProcess() {
        $.ajax({
            url: ajaxurl,
            type: 'POST',
            dataType: 'json',
            data: {
                action: 'rwwcl_bulk_convert',
                nonce: rwwcl_object.nonce,
            },
            success: function (response) {

                if (!response || response.success !== true) {
                    done();
                    return;
                }

                let progress = parseFloat(response.data.progress || 0);

                if (progress === lastProgress) {
                    stallCount++;
                } else {
                    stallCount = 0;
                    lastProgress = progress;
                }

                if (stallCount >= 5) {
                    console.error('Bulk convert stalled at', progress);
                    done();
                    return;
                }

                $progressInner.css('width', progress + '%');
                $progressText.text(progress + '%');

                // Is the process complete?
                if (response.data.finished || progress >= 100) {
                    done();
                    return;
                }

                // Otherwise, continue with the next batch.
                setTimeout(runBulkProcess, 200);
            },
            error: function () {
                done();
            }
        });
    }

    function done() {
        isProcessing = false;
        $progressText.text('Completed. Please refresh the page to view the latest data.');
        $progressInner.css('width', '100%');
        $startBtn.prop('disabled', false);
        $startBtn.text('Continue Bulk Conversion');

    }

});
