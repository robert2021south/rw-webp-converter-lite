jQuery(document).ready(function ($) {

    const $startBtn = $('#rwwcl-start-bulk');
    const $progressBox = $('#rwwcl-bulk-progress');
    const $progressInner = $('.rwwcl-progress-bar-inner');
    const $progressText = $('.rwwcl-progress-text');

    let isProcessing = false;

    $startBtn.on('click', function () {

        if (isProcessing) return;
        isProcessing = true;
        $startBtn.prop('disabled', true);

        $progressBox.show();
        $progressInner.css('width', '0%');
        $progressText.text('0%');

        runBulkProcess();
    });

    function runBulkProcess() {
        $.ajax({
            url: ajaxurl,
            type: 'POST',
            dataType: 'json',
            data: {
                action: 'rwwcl_bulk_convert',
                nonce: rwwcl_object.nonce,
            },
            success: function (response) {

                if (!response || response.success !== true) {
                    done();
                    return;
                }

                // 更新进度
                let progress = parseFloat(response.data.progress || 0);
                $progressInner.css('width', progress + '%');
                $progressText.text(progress + '%');

                // 是否完成？
                if (response.data.finished || progress >= 100) {
                    done();
                    return;
                }

                // 否则继续下一批
                setTimeout(runBulkProcess, 200);
            },
            error: function () {
                done();
            }
        });
    }

    function done() {
        isProcessing = false;
        $progressText.text('Completed');
        $progressInner.css('width', '100%');
        $startBtn.prop('disabled', false);
    }

});
